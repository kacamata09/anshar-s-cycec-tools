import socket
import os
import datetime


def receive_file(filename, host, port):
    try:
        server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        server_socket.bind((host, port))
        server_socket.listen(1)

        print(f"Try connect to {host}:{port}...")
        client_socket, client_address = server_socket.accept()
        print(f"Connect to {client_address}")

        with open(filename, "wb") as file:
            while True:
                data = client_socket.recv(1024)
                if not data:
                    break
                file.write(data)

        client_socket.close()
        server_socket.close()
        print(f"File success accept and filename : {filename}")

    except Exception as e:
        print(f"Error: {str(e)}")


def create_filename():
    today = str(datetime.datetime.today())
    filename = today.replace("-", "")
    filename = filename.replace(":", "")
    filename = filename.replace(" ", "_")[:-7]
    filename = "file" + filename
    return filename


if __name__ == "__main__":
    # count_file = 0

    # for i in reversed(range(1, 10000)):
    #     if os.path.exists(f"./file_{i:04d}"):
    #         count_file = i
    #         break

    # if count_file == 0:
    #     received_filename = "file_0001"
    #     count_file = 0

    host = "0.0.0.0"
    port = 9999
    while True:
        # count_file += 1
        # received_filename = f"file_{count_file:04d}"
        received_filename = create_filename()
        receive_file(received_filename, host, port)
